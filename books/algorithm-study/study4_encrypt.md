---
title: "暗号技術"
---

# はじめに
本章では暗号技術について触れていきます。公開鍵、秘密鍵とは何なのかを理解することが目的です。
早速問題を見ていきましょう。

# 問題
あなたはハッカーです。脆弱なサイトから、ユーザーの入力したパスワードを傍受することができました。
しかしパスワードはRSA暗号で暗号化されているので本当の中身はまだ分かりません。公開鍵は取得済みです。

公開鍵n,eと、暗号化されたパスワードcが以下のように与えられます。

```sh:input
901 # n
5 # e
836 # c
```

以下の手順に従って暗号文を復号(解読)してください。

1. nは素数p, qの積です。n = p × qとなるp, qを見つける。
2. e * d を (p - 1) * (q - 1)で割った余りが1となるようなdを見つける。ただし、d < (p - 1) * (q - 1)である。
3. cのd乗をnで割った余りが元の文となる。

なお、以下の条件に従ってください。

- 全てのテストケースで暗号が解読できる保証はありません
- 組み込みメソッドは使わないこと。つまり、分岐、繰り返し処理を自分で書くこと。
  - Array.findなどは使わない
- 解法を調べるためにchatgpt、インターネットは使用しないこと
  - 文法を調べることのみ可
- 計算量は問いません

## テストケース

```sh:input1
901
5
836
```

```sh:output1
777
```

```sh:input2
2773
17
1647
```

```sh:output2
2024
```

```sh:input3
23763750720320755089986836889386752333148454401954967562246067964867289138953959780717079688179130465650799885381128444602378117801374965735319583220896780571277261256156846877426142522785396049700319360493746460388891291877334647769138315576265478137249565382290203874694134519392957422540203022062882075405911121664718704644321479425687111651838911360686725629604293945223524169767648631213310792471748148155314286839441622349839299969847466395263222429344465646709824625925965427682282530676386023451803005481500038573372924827423756149573698159403684701896723624641100816859773212094543180200907204545388240139873
65537
8415193396543311353484421939238676093551842164971427185704097190178024351893340295680735321393780311840244869986682879096195012272166629614593460647812271305235527777754835140274392570370347880248411379950593107597810919502273451084589323176477491051476512881744527931527774798075893681139907243050509632488215183600512761950585193887831590494038281760727275445162394107244799292585041038475269525888152844146387779398177114276753330862352263395304480337880761057765477558514448524077641571808843866618899695005802755036106106076084395503279687316594954590030543862355124606471965783095127625163775336406697681524837
```

```sh:output3
893
```

## コマンドラインからの入力を受け取る方法
```py:python
n = int(input())
e = int(input())
c = int(input())
```

## 解答
:::details クリックすると解答例が見られます

```py:python
n = int(input())
e = int(input())
c = int(input())

def decrypt_rsa(n, e, c):
    # pとqを見つける（素因数分解。一つでも素数が見つかれば、自動的にもう片方も一つに定まる）
    p, q = None, None
    for i in range(2, n):
        if n % i == 0:
            p = i
            q = n // i
            break

    if not p or not q:
        return "pとqが見つかりませんでした。"

    # dを見つける
    phi = (p - 1) * (q - 1)
    d = None
    for i in range(1, phi):
        if (i * e) % phi == 1:
            d = i
            break

    if not d:
        return "dが見つかりませんでした。"

    # 暗号文cを復号する
    M = (c ** d) % n

    return M

# 復号されたパスワードを計算
decrypted = decrypt_rsa(n, e, c)

print(decrypted)
```

繰り返し処理を用いて、それぞれの指示に従ったプログラムを書きます。
テストケースは3つありますが、3つとも解読できたでしょうか？

3つ目の暗号はtimeoutになるはずです。これが解けたら世界のセキュリティが崩壊します。。。

:::

## 解説
RSA暗号は公開鍵暗号方式の一種となります。
なんとなく、公開鍵、秘密鍵という単語は聞いたことのある方も多いとは思いますが、上で見たように数式によって成立しているんですね。

:::message

上記の数式でなぜ元の文が復号できるのかの理論的な背景はこちらの記事に詳しいです。(数学の証明になります)
https://qiita.com/reika727/items/215d23bf18e21e3cbc52

:::

攻撃者の視点に立てば、pとqが分かれば暗号を解読することができます。
しかし、3つ目のテストケースは、617桁の途方もなく大きい数字(ちなみに無量大数は68桁)なので、素因数分解のプログラムがtimeoutしてしまいます。
実際にこれくらいのサイズの公開鍵がSSL等で利用されています。
また現代では、素因数分解のアルゴリズムはしらみ潰しに調べるO(n)の方法しか見つかっていません。

つまり、巨大な数字の素因数分解の困難さによってRSA暗号のセキュリティが保証されているのです。これをRSA仮定と言います。

RSA暗号は、あくまで現代の技術では解読できないという前提のもと成立している暗号化技術です。もし将来的に量子コンピュータの発展や、新たな素数の法則、新たな素因数分解のアルゴリズムが見つかってしまえば、現代のセキュリティが崩壊してしまう恐れがあることも理解しておく必要があります。

改めて、順を追ってRSA暗号の暗号化と復号化を見ていきましょう。

### step1 公開鍵(n,e)を用意する
まずサーバー側の立場に立って公開鍵を作ります。

1. 互いに素なp,qを任意に選びます。「互いに素」は、共通の約数が1以外に存在しない数字のペアを意味します。
2. n = pqとします。
3. (p - 1) * (q - 1)と互いに素な自然数eを任意に選びます。
4. e * dを(p - 1) * (q - 1)で割った余りが1となる自然数dを任意に選びます。

例えば以下のような数字を選びます。(簡単のため小さい数字を使います。)

1. p = 7、q = 5とする。
2. n = 7 * 5 = 35となる。
3. (p - 1) * (q - 1) = 6 * ４ = 24となるので、e ＝ 11とする。
4. 11 * dを24で割った余りが1となるdを探し、d = 83とする。(913 ÷ 24 = 38...あまり1)

このn = 35, e = 11を公開鍵として公開します。
p = 7, q = 5, d = 83は秘密鍵となります。

### step2 元の文を暗号化する
次にユーザーの立場に立って、公開鍵を利用して元の文を暗号化します。

1. 元の文mをe乗をnで割った余りが暗号文cとなります。

具体的に元の文m = 12として計算してみます。

1. c = 12の11乗を35で割った余り = 3

よって暗号文c = 3がサーバー側に送信されます。

### step3 暗号文を復号する
受信者であるサーバー側の視点に立って、暗号文を復号します。

1. cのd乗をnで割った余りが元の文となります。

具体的に、当てはめて計算してみます。

1. 3の83乗を35で割ったあまり = 12

このように復号することができました。

今までの流れを図示すると以下のようになります。

![RSA暗号](https://storage.googleapis.com/zenn-user-upload/d721b9ce5dfc-20240224.png)

n=pqが途方もなく大きいおかげで、攻撃者から通信を保護することができるというわけですね✨

# おわりに
本章では、暗号化をテーマに学びました。

普段利用するhttps(ssl)やsshも、RSA暗号のような暗号化技術が基になってプロトコルが制定されています。
なんとなく聞いたことのある公開鍵や秘密鍵の正体がこの記事を通して理解できたと思います。
また一つ、教養が深まりましたね🙌

# 参考文献

- https://qiita.com/reika727/items/215d23bf18e21e3cbc52
- https://web.quizknock.com/rsa-cryptosystem?page=1
